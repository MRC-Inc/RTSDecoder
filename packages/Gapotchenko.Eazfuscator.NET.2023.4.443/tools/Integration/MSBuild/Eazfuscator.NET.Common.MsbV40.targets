<!--
***********************************************************************************************
Eazfuscator.NET.Common.MsbV40.targets

WARNING:  DO NOT MODIFY this file. Incorrect changes to this file will make it impossible to
          load or build your Eazfuscator.NET projects from the command-line or the IDE.

Copyright (C) 2008-2023 Gapotchenko
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ProduceReferenceAssembly Condition=" '$(ProduceReferenceAssembly)' == '' AND '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' ">false</ProduceReferenceAssembly>
  </PropertyGroup>

  <!-- Override to specify actions to happen before obfuscating the project. -->
  <Target Name="BeforeEazfuscator" />

  <!-- Override to specify actions to happen after obfuscating the project. -->
  <Target Name="AfterEazfuscator" />

  <PropertyGroup>
    <_Eazfuscator_NET_DependsOn>
      $(_EazfuscatorDependsOn);
      BeforeEazfuscator;
      $(EazfuscatorTargetName);
      AfterEazfuscator
    </_Eazfuscator_NET_DependsOn>
    <_Eazfuscator_NET_CoreCompileTargets>
      CoreCompile;
      CreateSatelliteAssemblies
    </_Eazfuscator_NET_CoreCompileTargets>
  </PropertyGroup>

  <!-- The core Eazfuscator.NET target which can be used for customization purposes from your own targets. -->
  <Target Name="RunEazfuscator"
          Condition=" !('$(DesignTimeBuild)' == 'true' AND '$(EazfuscatorResponseFilePath)' == '') AND !('$(BuildingInsideVisualStudio)' == 'true' AND '$(BuildingOutOfProcess)' != 'true' AND '$(BuildingProject)' == 'false') AND ('$(_Eazfuscator_NET_TrackCompilationTimestamps)' == 'true' OR ($(NonExistentFile) == '' OR '$(_Eazfuscator_NET_IgnoreNonExistentFile)' == 'true')) AND ('$(_Eazfuscator_NET_TrackCompilationTimestamps)' != 'true' OR '$(_Eazfuscator_NET_AssemblyTimestampChanged)' == 'true') "
          DependsOnTargets="_Eazfuscator_NET_ValidatePrerequisites">
    <PropertyGroup>
      <_Eazfuscator_NET_TargetPath>$(_Eazfuscator_NET_RetargetedPath)</_Eazfuscator_NET_TargetPath>
      <_Eazfuscator_NET_RetargetedPath />
      <_Eazfuscator_NET_TargetPath Condition=" '$(_Eazfuscator_NET_TargetPath)' == '' ">$(TargetPath)</_Eazfuscator_NET_TargetPath>
      <_Eazfuscator_NET_ResponseFile>$(EazfuscatorResponseFilePath)</_Eazfuscator_NET_ResponseFile>
      <_Eazfuscator_NET_ResponseFile Condition=" '$(_Eazfuscator_NET_ResponseFile)' == '' ">$(IntermediateOutputPath)Eazfuscator.NET.rsp</_Eazfuscator_NET_ResponseFile>
      <_Eazfuscator_NET_CrossTargetingBuild>false</_Eazfuscator_NET_CrossTargetingBuild>
      <_Eazfuscator_NET_CrossTargetingBuild Condition=" '$(TargetFrameworks)' != '' AND '$(TargetFrameworks)' != '$(TargetFramework)' ">true</_Eazfuscator_NET_CrossTargetingBuild>
    </PropertyGroup>
    <ItemGroup>
      <_Eazfuscator_NET_NuGet_PkgPathProperties Include="@(PackageReference)" Condition=" '%(PackageReference.GeneratePathProperty)' == 'True' " KeepMetadata="Identity">
        <PropertyName>$([System.String]::new('%(Identity)').Replace('.', '_').Insert(0, 'Pkg'))</PropertyName>
      </_Eazfuscator_NET_NuGet_PkgPathProperties>
      <_Eazfuscator_NET_NuGet_PkgPathArguments Include="@(_Eazfuscator_NET_NuGet_PkgPathProperties)" Condition=" '$(%(PropertyName))' != '' ">
        <CmdArgument>--msbuild-property %(PropertyName)=&quot;$(%(PropertyName))&quot;</CmdArgument>
      </_Eazfuscator_NET_NuGet_PkgPathArguments>
    </ItemGroup>
    <ItemGroup>
      <_Eazfuscator_NET_Arg Remove="@(_Eazfuscator_NET_Arg)" />

      <_Eazfuscator_NET_Arg Include="--msbuild-project-path &quot;$([MSBuild]::Escape($(ProjectPath)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-project-configuration &quot;$([MSBuild]::Escape($(ConfigurationName)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-project-platform &quot;$([MSBuild]::Escape($(PlatformName)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-solution-path &quot;$([MSBuild]::Escape($(SolutionPath)))&quot;" />

      <_Eazfuscator_NET_Arg Include="--msbuild-sign-assembly &quot;$([MSBuild]::Escape($(SignAssembly)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-assembly-originator-key-file &quot;$([MSBuild]::Escape($(AssemblyOriginatorKeyFile)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-delay-sign &quot;$([MSBuild]::Escape($(DelaySign)))&quot;" />

      <_Eazfuscator_NET_Arg Include="--msbuild-sign-manifests &quot;$([MSBuild]::Escape($(SignManifests)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-manifest-key-file &quot;$([MSBuild]::Escape($(ManifestKeyFile)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-manifest-certificate-thumbprint &quot;$([MSBuild]::Escape($(ManifestCertificateThumbprint)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-manifest-timestamp-url &quot;$([MSBuild]::Escape($(ManifestTimestampUrl)))&quot;" />

      <_Eazfuscator_NET_Arg Include="--msbuild-target-framework &quot;$([MSBuild]::Escape($(TargetFramework)))&quot;" Condition=" '$(TargetFramework)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-cross-targeting" Condition="$(_Eazfuscator_NET_CrossTargetingBuild)" />

      <_Eazfuscator_NET_Arg Include="--msbuild-runtime-identifier &quot;$([MSBuild]::Escape($(RuntimeIdentifier)))&quot;" Condition=" '$(RuntimeIdentifier)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-runtime-identifiers &quot;$([MSBuild]::Escape($(RuntimeIdentifiers)))&quot;" Condition=" '$(RuntimeIdentifiers)' != '' " />

      <_Eazfuscator_NET_Arg Include="--msbuild-intermediate-output-path &quot;$([MSBuild]::Escape($(IntermediateOutputPath.TrimEnd('\'))))&quot;" />
      <_Eazfuscator_NET_Arg Include="--msbuild-project-assets-file &quot;$([MSBuild]::Escape($(ProjectAssetsFile)))&quot;" Condition=" '$(ProjectAssetsFile)' != '' " />

      <_Eazfuscator_NET_Arg Include="--visual-studio-version &quot;$([MSBuild]::Escape($(VisualStudioVersion)))&quot;" Condition=" '$(VisualStudioVersion)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-project-type &quot;$([MSBuild]::Escape($(_Eazfuscator_NET_ProjectType)))&quot;" Condition=" '$(_Eazfuscator_NET_ProjectType)' != '' " />

      <_Eazfuscator_NET_Arg Include="-n -v &quot;$([MSBuild]::Escape($(EazfuscatorCompatibilityVersion)))&quot;" />
      <_Eazfuscator_NET_Arg Include="--newline-flush" />

      <_Eazfuscator_NET_Arg Include="--reference-paths &quot;" />
      <_Eazfuscator_NET_Arg Include="@(ReferencePath)" />
      <_Eazfuscator_NET_Arg Include="&quot;" />

      <_Eazfuscator_NET_Arg Include="%(_Eazfuscator_NET_NuGet_PkgPathArguments.CmdArgument)" />
      <_Eazfuscator_NET_Arg Include="--msbuild-property NuGetPackageRoot=&quot;$([MSBuild]::Escape($(NuGetPackageRoot.TrimEnd('\'))))&quot;" Condition=" '$(NuGetPackageRoot)' != '' " />

      <_Eazfuscator_NET_Arg Include="--msbuild-property RestorePackagesPath=&quot;$([MSBuild]::Escape($(RestorePackagesPath.TrimEnd('\'))))&quot;" Condition=" '$(RestorePackagesPath)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-property RestorePackagesConfig=&quot;$([MSBuild]::Escape($(RestorePackagesConfig)))&quot;" Condition=" '$(RestorePackagesConfig)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-property RestoreConfigFile=&quot;$([MSBuild]::Escape($(RestoreConfigFile)))&quot;" Condition=" '$(RestoreConfigFile)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-property RestoreAdditionalProjectSources=&quot;$([MSBuild]::Escape($(RestoreAdditionalProjectSources)))&quot;" Condition=" '$(RestoreAdditionalProjectSources)' != '' " />
      <_Eazfuscator_NET_Arg Include="--msbuild-property RestoreRepositoryPath=&quot;$([MSBuild]::Escape($(RestoreRepositoryPath.TrimEnd('\'))))&quot;" Condition=" '$(RestoreRepositoryPath)' != '' " />

      <_Eazfuscator_NET_Arg Include="--msbuild-property EazfuscatorLicense=&quot;$([MSBuild]::Escape($(EazfuscatorLicense)))&quot;" Condition=" '$(EazfuscatorLicense)' != '' " />

      <_Eazfuscator_NET_Arg Include="$([MSBuild]::Escape($(EazfuscatorExtraArgs)))" Condition=" '$(EazfuscatorExtraArgs)' != '' " />
    </ItemGroup>
    <PropertyGroup>
      <_Eazfuscator_NET_ProjectType />
    </PropertyGroup>
    <WriteLinesToFile File="$(_Eazfuscator_NET_ResponseFile)" Lines="@(_Eazfuscator_NET_Arg)" Overwrite="true" Encoding="UTF-8" />
    <ItemGroup>
      <_Eazfuscator_NET_Arg Remove="@(_Eazfuscator_NET_Arg)" />
    </ItemGroup>
    <Exec Command="&quot;$(EazfuscatorPath)&quot; &quot;$(_Eazfuscator_NET_TargetPath)&quot; &quot;@$(_Eazfuscator_NET_ResponseFile)&quot;"
          IgnoreExitCode="true"
          Condition=" '$(DesignTimeBuild)' != 'true' AND '$(EazfuscatorSkipExecution)' != 'true' ">
      <Output TaskParameter="ExitCode" PropertyName="_Eazfuscator_NET_ExitCode" />
    </Exec>
    <Error Text="Obfuscation failed" File="$(TargetFileName)" Condition=" '$(DesignTimeBuild)' != 'true' AND '$(EazfuscatorSkipExecution)' != 'true' AND '$(_Eazfuscator_NET_ExitCode)' != '0' " />
    <Delete Files="$(_Eazfuscator_NET_ResponseFile)" TreatErrorsAsWarnings="true" Condition=" '$(EazfuscatorKeepResponseFile)' != 'true' " />

    <CallTarget Targets="$(_Eazfuscator_NET_TriggeredTargets)" Condition=" '$(_Eazfuscator_NET_TriggeredTargets)' != '' " />

    <CallTarget Targets="$(EazfuscatorTriggeredTargets)" Condition=" '$(EazfuscatorTriggeredTargets)' != '' " />
  </Target>

  <Target Name="_Eazfuscator_NET_Default"
          Condition=" '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' "
          DependsOnTargets="RunEazfuscator" />

  <Target Name="_Eazfuscator_NET"
          Condition=" '$(EazfuscatorIntegration)' == 'MSBuild' AND (('$(DesignTimeBuild)' == 'true' AND '$(SkipCompilerExecution)' == 'true' AND '$(EazfuscatorResponseFilePath)' != '') OR Exists('$(TargetPath)') OR Exists('$(_Eazfuscator_NET_RetargetedPath)')) "
          DependsOnTargets="$(_Eazfuscator_NET_DependsOn)" />

  <Target Name="_Eazfuscator_NET_ValidatePrerequisites"
          Condition=" '$(EazfuscatorSkipExecution)' != 'true' ">
    <Eazfuscator_NET_PrerequisitesValidationTask />
  </Target>

  <Target Name="_Eazfuscator_NET_RetargetToIntermediate">
    <CreateProperty Value="@(IntermediateAssembly)">
      <Output TaskParameter="Value" PropertyName="_Eazfuscator_NET_RetargetedPath" />
    </CreateProperty>
  </Target>

  <Target Name="_Eazfuscator_NET_GetRemovedReferencePaths"
          Condition=" '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' AND Exists('$(IntermediateOutputPath)eazfuscator_cache\$packaging\RemovedReferencePaths.txt') ">
    <PropertyGroup>
      <_Eazfuscator_NET_RemovedReferencePaths_FilePath>$(IntermediateOutputPath)eazfuscator_cache\$packaging\RemovedReferencePaths.txt</_Eazfuscator_NET_RemovedReferencePaths_FilePath>
    </PropertyGroup>
    <ReadLinesFromFile File="$(_Eazfuscator_NET_RemovedReferencePaths_FilePath)">
      <Output TaskParameter="Lines" ItemName="_Eazfuscator_NET_RemovedReferencePaths"/>
    </ReadLinesFromFile>
  </Target>

  <!-- ====================================================================================== -->

  <Target Name="_Eazfuscator_NET_CheckActivation"
          BeforeTargets="BeforeBuild">
    <Eazfuscator_NET_CheckActivation CurrentConfiguration="$(Configuration)"
                                     ActiveConfigurations="$(EazfuscatorActiveConfigurations)"
                                     Condition=" '$(EazfuscatorActiveConfiguration)' == '' AND '$(EazfuscatorActiveConfigurations)' != '' " >
      <Output TaskParameter="ActivationEnabled" PropertyName="_Eazfuscator_NET_ActivationEnabled"/>
    </Eazfuscator_NET_CheckActivation>
    <PropertyGroup>
      <EazfuscatorActiveConfiguration Condition=" '$(_Eazfuscator_NET_ActivationEnabled)' == 'true' ">$(Configuration)</EazfuscatorActiveConfiguration>
      <EazfuscatorActiveConfiguration Condition=" '$(EazfuscatorActiveConfiguration)' == '' AND '$(_Eazfuscator_NET_ActivationEnabled)' == '' ">Release</EazfuscatorActiveConfiguration>
    </PropertyGroup>
  </Target>

  <!-- ====================================================================================== -->

  <Target Name="_Eazfuscator_NET_ActivationTrigger"
          Condition=" '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' "
          BeforeTargets="CoreCompile">
    <CallTarget Targets="$(_Eazfuscator_NET_ActivationTargets)" Condition=" '$(_Eazfuscator_NET_ActivationTargets)' != '' " />
  </Target>

  <Target Name="_Eazfuscator_NET_CompilationTrigger"
          Condition=" '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' "
          DependsOnTargets="_Eazfuscator_NET_ActivationTrigger">
    <CallTarget Targets="$(_Eazfuscator_NET_TriggerTargets)" Condition=" '$(_Eazfuscator_NET_TriggerTargets)' != '' " />
  </Target>

  <PropertyGroup>
    <TargetsTriggeredByCompilation>$(TargetsTriggeredByCompilation);_Eazfuscator_NET_CompilationTrigger</TargetsTriggeredByCompilation>
  </PropertyGroup>

  <!-- ====================================================================================== -->

  <PropertyGroup>
    <_Eazfuscator_NET_TrackCompilationTimestamps />
    <_Eazfuscator_NET_TrackCompilationTimestamps Condition=" '$(VisualStudioVersion)' == '10.0' OR '$(VisualStudioVersion)' == '11.0' OR '$(VisualStudioVersion)' == '12.0' OR '$(Eazfuscator_NET_RiderVersion)' != '' ">true</_Eazfuscator_NET_TrackCompilationTimestamps>
  </PropertyGroup>

  <Target Name="_Eazfuscator_NET_TimeStampBeforeCompile"
          Condition=" '$(_Eazfuscator_NET_TrackCompilationTimestamps)' == 'true' "
          BeforeTargets="CoreCompile">
    <PropertyGroup>
      <_Eazfuscator_NET_AssemblyTimestampBeforeCompile>%(IntermediateAssembly.ModifiedTime)</_Eazfuscator_NET_AssemblyTimestampBeforeCompile>
    </PropertyGroup>
  </Target>

  <Target Name="_Eazfuscator_NET_TimeStampAfterCompile"
          Condition=" '$(_Eazfuscator_NET_TrackCompilationTimestamps)' == 'true' "
          AfterTargets="CoreCompile">
    <PropertyGroup>
      <_Eazfuscator_NET_AssemblyTimestampAfterCompile>%(IntermediateAssembly.ModifiedTime)</_Eazfuscator_NET_AssemblyTimestampAfterCompile>
      <_Eazfuscator_NET_AssemblyTimestampChanged Condition=" '$(_Eazfuscator_NET_AssemblyTimestampBeforeCompile)' != '$(_Eazfuscator_NET_AssemblyTimestampAfterCompile)' ">true</_Eazfuscator_NET_AssemblyTimestampChanged>
    </PropertyGroup>
  </Target>

  <!-- ====================================================================================== -->

  <Target Name="_Eazfuscator_NET_GetNewOutputFilePaths_SA"
          Condition=" '$(Configuration)' == '$(EazfuscatorActiveConfiguration)' AND Exists('$(IntermediateOutputPath)eazfuscator_cache\$packaging\NewOutputFilePaths.SA.txt') ">
    <PropertyGroup>
      <_Eazfuscator_NET_NewOutputFilePaths_SA_FilePath>$(IntermediateOutputPath)eazfuscator_cache\$packaging\NewOutputFilePaths.SA.txt</_Eazfuscator_NET_NewOutputFilePaths_SA_FilePath>
    </PropertyGroup>
    <ReadLinesFromFile File="$(_Eazfuscator_NET_NewOutputFilePaths_SA_FilePath)">
      <Output TaskParameter="Lines" ItemName="_Eazfuscator_NET_NewOutputFilePaths_SA"/>
    </ReadLinesFromFile>
    <ItemGroup>
      <_Eazfuscator_NET_NewOutputSatelliteAssemblies Include="%(_Eazfuscator_NET_NewOutputFilePaths_SA.Identity)" Condition=" '%(Identity)' != '' ">
        <Culture>$([System.IO.Path]::GetFileName($([System.IO.Path]::GetDirectoryName('%(Identity)'))))</Culture>
        <TargetPath>%(_Eazfuscator_NET_NewOutputSatelliteAssemblies.Culture)\$([System.IO.Path]::GetFileName('%(Identity)'))</TargetPath>
      </_Eazfuscator_NET_NewOutputSatelliteAssemblies>
    </ItemGroup>
  </Target>

  <!-- ====================================================================================== -->

  <Import Project="Eazfuscator.NET.WinRT.targets" />
  <Import Project="Eazfuscator.NET.VSIX.targets" />
  <Import Project="Eazfuscator.NET.SQL.targets" />
  <Import Project="Eazfuscator.NET.WiX.targets" Condition=" '$(WixCATargetsPath)' != '' "/>

  <Import Project="Eazfuscator.NET.NETFramework.targets" />

  <Import Project="Eazfuscator.NET.Common.MsbV150.targets" Condition=" '$(Eazfuscator_NET_MSBuildToolsVersion)' &gt;= '15.0' " />

  <Import Project="Eazfuscator.NET.ClickOnce.targets" />
  <Import Project="Eazfuscator.NET.WAP.targets" />

</Project>
